<!DOCTYPE html>
<html>
<head>
<title>Contacts Page Debug</title>
<style>
  body { font-family: monospace; margin: 20px; background: #f0f0f0; }
  .section { background: white; padding: 15px; margin: 10px 0; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
  .success { color: green; font-weight: bold; }
  .error { color: red; font-weight: bold; }
  .warn { color: orange; font-weight: bold; }
  pre { background: #f5f5f5; padding: 10px; border-radius: 3px; overflow-x: auto; max-height: 400px; }
  button { padding: 8px 15px; margin: 5px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 3px; }
  button:hover { background: #0056b3; }
</style>
</head>
<body>
<h1>üîç Contacts Page - Deep Debug</h1>

<div class="section">
  <h2>1. Page Elements in DOM</h2>
  <button onclick="checkPageElements()">Check Elements</button>
  <div id="elementsCheck"></div>
</div>

<div class="section">
  <h2>2. API Call Test</h2>
  <button onclick="testAPICall()">Test API Call</button>
  <div id="apiCheck"></div>
</div>

<div class="section">
  <h2>3. Console Errors</h2>
  <button onclick="captureConsoleErrors()">Capture Console</button>
  <div id="consoleCheck"></div>
</div>

<div class="section">
  <h2>4. JavaScript Functions</h2>
  <button onclick="checkJSFunctions()">Check JS Functions</button>
  <div id="jsCheck"></div>
</div>

<div class="section">
  <h2>5. LocalStorage & Session</h2>
  <button onclick="checkStorage()">Check Storage</button>
  <div id="storageCheck"></div>
</div>

<script>
// Capture console errors
let consoleErrors = [];
const originalError = console.error;
console.error = function(...args) {
  consoleErrors.push(args.map(a => typeof a === 'string' ? a : JSON.stringify(a)).join(' '));
  originalError.apply(console, args);
};

function checkPageElements() {
  const check = document.getElementById('elementsCheck');
  const table = document.querySelector('[data-page="contacts"]');
  const tableBody = document.getElementById('contactsTableBody');
  const addBtn = document.getElementById('contactAddBtn');
  const formContainer = document.getElementById('contactFormContainer');
  const form = document.getElementById('contactForm');
  
  check.innerHTML = `
    <div><strong>Main page container:</strong> ${table ? '<span class="success">‚úì FOUND</span>' : '<span class="error">‚úó NOT FOUND</span>'}</div>
    <div>  ‚îî‚îÄ [data-page="contacts"] found: ${!!table}</div>
    <br/>
    <div><strong>Table body:</strong> ${tableBody ? '<span class="success">‚úì FOUND</span>' : '<span class="error">‚úó NOT FOUND</span>'}</div>
    <div>  ‚îî‚îÄ #contactsTableBody found: ${!!tableBody}</div>
    <br/>
    <div><strong>Add button:</strong> ${addBtn ? '<span class="success">‚úì FOUND</span>' : '<span class="error">‚úó NOT FOUND</span>'}</div>
    <div>  ‚îî‚îÄ #contactAddBtn found: ${!!addBtn}</div>
    <br/>
    <div><strong>Form container:</strong> ${formContainer ? '<span class="success">‚úì FOUND</span>' : '<span class="error">‚úó NOT FOUND</span>'}</div>
    <div>  ‚îî‚îÄ #contactFormContainer found: ${!!formContainer}</div>
    <br/>
    <div><strong>Form element:</strong> ${form ? '<span class="success">‚úì FOUND</span>' : '<span class="error">‚úó NOT FOUND</span>'}</div>
    <div>  ‚îî‚îÄ #contactForm found: ${!!form}</div>
  `;
}

async function testAPICall() {
  const check = document.getElementById('apiCheck');
  check.innerHTML = '<div>Testing...</div>';
  
  try {
    const res = await fetch('/api.php?page=clients');
    const data = await res.json();
    
    check.innerHTML = `
      <div><strong>Status:</strong> ${res.status}</div>
      <div><strong>Clients returned:</strong> ${data.clients?.length || 0}</div>
      <div><strong>Total in DB:</strong> ${data.meta?.total || 0}</div>
      <pre>${JSON.stringify(data, null, 2)}</pre>
      ${res.ok && data.clients?.length > 0 ? '<div class="success">‚úì API working, data available</div>' : '<div class="error">‚úó API not returning data</div>'}
    `;
  } catch (err) {
    check.innerHTML = `<div class="error">‚úó API Error: ${err.message}</div><pre>${err.stack}</pre>`;
  }
}

function captureConsoleErrors() {
  const check = document.getElementById('consoleCheck');
  check.innerHTML = consoleErrors.length > 0 
    ? `<div class="error">Found ${consoleErrors.length} error(s):</div><pre>${consoleErrors.join('\n\n')}</pre>`
    : '<div class="success">‚úì No console errors captured</div>';
}

function checkJSFunctions() {
  const check = document.getElementById('jsCheck');
  const initClients = typeof window.initClients === 'function';
  const apiClient = typeof window.apiClient === 'object' && window.apiClient !== null;
  const ui = typeof window.ui === 'object' && window.ui !== null;
  
  check.innerHTML = `
    <div><strong>initClients():</strong> ${initClients ? '<span class="success">‚úì FOUND</span>' : '<span class="error">‚úó NOT FOUND</span>'}</div>
    <div><strong>apiClient:</strong> ${apiClient ? '<span class="success">‚úì FOUND</span>' : '<span class="error">‚úó NOT FOUND</span>'}</div>
    <div><strong>ui:</strong> ${ui ? '<span class="success">‚úì FOUND</span>' : '<span class="error">‚úó NOT FOUND</span>'}</div>
  `;
}

function checkStorage() {
  const check = document.getElementById('storageCheck');
  const token = localStorage.getItem('token') || sessionStorage.getItem('token') || (document.cookie.includes('auth_token') ? 'Set in cookies' : 'NOT FOUND');
  const clientSearch = localStorage.getItem('crm_client_search');
  
  check.innerHTML = `
    <div><strong>Auth Token:</strong> ${token === 'NOT FOUND' ? '<span class="error">‚úó NOT FOUND</span>' : '<span class="success">‚úì FOUND</span>'}</div>
    <div>  ‚îî‚îÄ Value: ${token?.substring ? token.substring(0, 30) + '...' : token}</div>
    <br/>
    <div><strong>Client Search Filter:</strong> ${clientSearch ? '<span class="warn">‚ö†Ô∏è ACTIVE: ' + clientSearch + '</span>' : '<span class="success">‚úì None (good)</span>'}</div>
  `;
}

// Run on load
window.addEventListener('load', () => {
  checkPageElements();
  checkJSFunctions();
  checkStorage();
  testAPICall();
});
</script>
</body>
</html>
